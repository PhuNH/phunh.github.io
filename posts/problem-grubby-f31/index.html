<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Interesting and/or useful things (to me)"><link rel="shortcut icon" href=https://phunh.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.609872059387950283d8b6ce9f9f1d1d35946704e753486966b9b6d2afe0ccc3.css><title>grubby and BootLoaderSpec - and grubby-deprecated</title></head><body><header id=banner><h2><a href=https://phunh.github.io/posts/problem-grubby-f31/>grubby and BootLoaderSpec - and grubby-deprecated</a></h2><nav><ul><li><a href=https://phunh.github.io>home</a></li><li><a href=/posts/>posts</a></li><li><a href=/notes/>notes</a></li><li><a href=/tags/>tags</a></li><li><a href=/about/>about</a></li></ul></nav></header><main id=content><article><header id=post-header><small><time>Updated on 23 Apr 2020</time></small><div class=tagline>Phu
&emsp;|&emsp;5 minutes&emsp;|&emsp;Tags:
&nbsp;<a class=tag href=/tags/grubby/>grubby</a>
&nbsp;<a class=tag href=/tags/grub2/>grub2</a>
&nbsp;<a class=tag href=/tags/boot/>boot</a>
&nbsp;<a class=tag href=/tags/bootloaderspec/>bootloaderspec</a>
&nbsp;<a class=tag href=/tags/f31/>f31</a>
&nbsp;<a class=tag href=/tags/fedora/>fedora</a>
&nbsp;<a class=tag href=/tags/troubleshoot/>troubleshoot</a></div></header><p>My machine running Fedora 30 was upgraded to version 31 on March 21st. When rebooting I got no grub menu and a [fatal error]({{ &lsquo;/posts/upgrade-f31-kde#delcreating-boot-menu-and-booting-updel&rsquo; | relative_url }}). This post is about what I have done to resolve this issue.</p><h4 id=how-to-make-changes-to-your-system-when-you-cant-boot-into-it>How to make changes to your system when you can&rsquo;t boot into it</h4><p>You need a live system! Or maybe there are better ways but so far this is the best I know of. I also heard about <em>rescue mode</em> but people seem to have to wait at that error screen for quite a long time before the mode activates, so a reset might be faster.</p><p>From the live system, you can use <code>chroot</code> command to basically operate as if your root is in your unbootable system, so that you can fix its problems. Do these things in your terminal:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; sudo -i <span style=color:#8f5902;font-style:italic># keep yourself as an admin</span>
<span style=color:#8f5902;font-style:italic># list all (-a) disks and partitions with filesystems (-f) and device paths (-p)</span>
&gt; lsblk -fap 
&gt; mount &lt;root-partition-path&gt; /mnt
<span style=color:#8f5902;font-style:italic># also mount your boot partition, can be useful here</span>
&gt; mount &lt;boot-partition-path&gt; /mnt/boot/efi <span style=color:#8f5902;font-style:italic># suppose you are using UEFI</span>
<span style=color:#8f5902;font-style:italic># these are to make sure the chroot-ed system works</span>
&gt; mount -o <span style=color:#204a87>bind</span> /dev /mnt/dev
&gt; mount -o <span style=color:#204a87>bind</span> /proc /mnt/proc
&gt; mount -o <span style=color:#204a87>bind</span> /run /mnt/run
&gt; mount -o <span style=color:#204a87>bind</span> /sys /mnt/sys
<span style=color:#8f5902;font-style:italic># now we can change the root</span>
&gt; chroot /mnt
<span style=color:#8f5902;font-style:italic># and now it&#39;s like we are in the system we need to repair</span></code></pre></div><h4 id=the-problem>The problem</h4><p>From the chroot-ed system I could check log with <em>journalctl</em> and saw an error message &ldquo;<em>grubby fatal error: unable to find a suitable template</em>&rdquo;. I also checked <em>grub.cfg</em> in both <em>/boot/grub2/</em> and <em>/boot/efi/EFI/fedora/</em>, since the problem might be with grub, and saw in both a huge amount of the root partition&rsquo;s UUID repeated in the default kernel option:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>set</span> <span style=color:#000>default_kernelopts</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557=4298dad3-baa3-4843-9fcf-c849f4cdf557 ro resume=UUID=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac=9a58685a-be9a-4b36-99a2-7c50f19938ac &#34;</span></code></pre></div><p>And this is just a shorter version, with the root partition&rsquo;s UUID appearing 179 times, recreated after I had figured out the issue. The real one I saw had that UUID repeated for 21949 times. So this was the reason for the &ldquo;<em>token too large, exceeds YYLMAX</em>&rdquo; error. But why? And what&rsquo;s up with a template for <em>grubby</em>? Anyway, <code>grub2-mkconfig</code> can help remaking the grub config file, so I moved on.</p><p>On March 29th and April 3rd, I ran kernel updates, both of which ended up again with the error message about the grubby&rsquo;s template, and a process being killed:</p><pre><code>/sbin/new-kernel-pkg: line 321: 170010 Killed   $grubby --grub2 -c $grub2Config --remove-kernel=$kernelImage
</code></pre><p>The grub config files again contained the same amount of UUID strings. So <em>grubby</em> might have been killed because of this.</p><p>Should I continue running <code>grub2-mkconfig</code> everytime I update the kernel? I don&rsquo;t want to have error logs either, so no. At this point it&rsquo;s all about <em>grubby</em>: the <code>new-kernel-pkg</code> script called grubby to change the grub config file and then got a bad file, grubby also wanted a template which seemed to not exist. So let&rsquo;s read grubby code to see what it does.</p><h4 id=the-reason>The reason</h4><p>From <a href=https://fedoraproject.org/wiki/Releases/30/ChangeSet#Make_BootLoaderSpec-style_configuration_files_the_default>Fedora 30</a>, BootLoaderSpec (BLS)-style config files have been made the default for configuring the bootloader&rsquo;s menu entries. I don&rsquo;t actually know when it came to my machine, just remember that at some point when running <code>grub2-mkconfig</code> I didn&rsquo;t see Fedora entries anymore, only the Windows one. And since after using <code>grub2-mkconfig</code> to recreate <em>grub.cfg</em> I could boot normally, it&rsquo;s safe to assume that what it creates is good with grub and BLS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>set</span> <span style=color:#000>default_kernelopts</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root=UUID=4298dad3-baa3-4843-9fcf-c849f4cdf557 ro resume=UUID=9a58685a-be9a-4b36-99a2-7c50f19938ac &#34;</span></code></pre></div><p>The issue is that <em>grubby</em> considers the equal sign <code>=</code> a kind of separator between the name and the value of a key, and it doesn&rsquo;t know about the BLS-style that config line is using, so when parsing the config file, it replicates every right hand side of each equal sign. After it runs once, the number of times the root partition&rsquo;s UUID appears in that line increases from 1 to 3, twice, to 14, three times, to 179, and four times, to 21949.</p><p><strong>So how did <em>grubby</em> get called after each kernel update?</strong></p><p>There are 2 macros in <a href=https://src.fedoraproject.org/rpms/kernel/blob/f31/f/kernel.spec#_2618><em>kernel.spec</em></a> file, which run the kernel-install script: <code>kernel_variant_posttrans</code> runs the <code>add</code> command and <code>kernel_variant_preun</code> runs the <code>remove</code> command. These in turn <a href=http://man7.org/linux/man-pages/man8/kernel-install.8.html>trigger</a> the corresponding <code>add</code> and <code>remove</code> parts of scripts in both <em>/usr/lib/kernel/install.d/</em> and <em>/etc/kernel/install.d/</em>.</p><p>In <em>/usr/lib/kernel/install.d/</em> I have <code>20-grubby.install</code> which a bit surprisingly comes from the package <em>systemd-udev</em> and runs <code>new-kernel-pkg</code> to install a new bootloader&rsquo;s menu entry, add a new kernel image, update the rescue image, and remove the old kernel, all using <em>grubby</em>. The command in the error message <code>$grubby --grub2 -c $grub2Config --remove-kernel=$kernelImage</code> can also be found in this <code>new-kernel-pkg</code> script.</p><p>There is also the <code>20-grub.install</code> script in that folder, which comes from <em>grub2-common</em> package and also uses <code>new-kernel-pkg</code> to do those tasks, but only when that script exists <a href=https://src.fedoraproject.org/rpms/grub2/blob/f31/f/20-grub.install#_80>AND</a> grub doesn&rsquo;t have BLS enabled (<code>GRUB_ENABLE_BLSCFG != true</code>). This config can be found in <em>/etc/default/grub</em> and I have it set to true.</p><p>The question now is: <strong>why is <code>new-kernel-pkg</code> there?</strong> If it&rsquo;s not there, grubby won&rsquo;t be called, no error.</p><p>And surprise surprise, which package contains that script? <em>grubby-deprecated</em>.</p><p>When did I install it? March 19th.</p><p>Why did I do that? I don&rsquo;t remember.</p><p>What should I do now? Remove <em>grubby-deprecated</em>, I guess.</p><p>And right now while I&rsquo;m writing this post, a new kernel update is available. Let&rsquo;s see how it goes&mldr;</p><p>While waiting for the update to finish, let&rsquo;s talk about the grubby&rsquo;s template. It will be resolved anyway when we get rid of <code>new-kernel-pkg</code>, but just for the sake of completeness: <em>grubby</em> tries to find a menu entry and to use it as a default template to create another one, but it can&rsquo;t, since with this BLS-styled grub, configs for menu entries are stored in separated files, not in the grub config file anymore.</p><p>Update finishes. No more grubby. Done.</p><footer><a class=next href=https://phunh.github.io/posts/jekyll+_-sl%C6%B0%C3%BC.g/>Next >></a>
<a href=https://phunh.github.io/posts/toggle-krunner-plasma-5.17/>&lt;&lt; Prev</a></footer></article></main><footer id=footer><div>Copyright © 2021 Phu Hung Nguyen</div><div>Foo or Phu? - Interesting and/or useful things (to me)</div><div><a href=https://github.com/phunh target=_blank>GitHub</a>
● <a href=https://twitter.com/phuhnguyen target=_blank>Twitter</a></div></footer></body></html>