name: deploy

on:
  push:
    branches:
    - source

jobs:
  jekyll:
    runs-on: ubuntu-16.04
    steps:
    - name: ğŸ“‚ setup
      uses: actions/checkout@v2
      
    - id: find # this step is needed to provide the cache directory and cache hash key
      name: ğŸ“‚ find jekyll directory
      run: |
        JEKYLL_SRC=$(find . -path ./vendor/bundle -prune -o -name _config.yml -exec dirname {} \; | tr -d '\n')
        JEKYLL_HASH=$(ls -alR --full-time ${JEKYLL_SRC} | sha1sum)
        echo "::set-output name=jekyllSrc::${JEKYLL_SRC}"
        echo "::set-output name=jekyllHash::${JEKYLL_HASH}"

    # Use GitHub Actions' cache to shorten build times and decrease load on servers
    - name: ğŸ“ cache bundler files
      uses: actions/cache@v1
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
    
    - name: ğŸ“ cache jekyll files
      uses: actions/cache@v1
      with:
        path: ${{ steps.find.outputs.jekyllSrc }}/.jekyll-cache
        key: ${{ runner.os }}-jekyll-${{ steps.find.outputs.jekyllHash }}
        restore-keys: |
          ${{ runner.os }}-jekyll-

    - name: ğŸ’ setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.6 # can change this to 2.7 or whatever version you prefer
    
    - name: ğŸ”¨ install dependencies & build site
      uses: limjh16/jekyll-action-ts@v2
      with:
        jekyll_src: ${{ steps.find.outputs.jekyllSrc }}

    - name: ğŸš€ deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        # if the repo you are deploying to is <username>.github.io, uncomment the line below.
        # if you are including the line below, make sure your source files are NOT in the master branch:
        publish_branch: master

